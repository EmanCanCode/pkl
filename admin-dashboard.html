<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>PKL.CLUB | Admin Dashboard</title>
  <!-- Stylesheets -->
  <link href="css/bootstrap.min.css" rel="stylesheet" />
  <link href="css/style.css" rel="stylesheet" />
  <link href="css/fontawesome.css" rel="stylesheet" />
  <link href="css/linear.css" rel="stylesheet" />
  <link href="css/dashboard.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Luckiest+Guy&family=Ubuntu:wght@300;400;500;700&display=swap"
    rel="stylesheet" />

  <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
  <link rel="icon" href="images/favicon.png" type="image/x-icon" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", sans-serif;
      min-height: 100vh;
      background-color: #040b1d;
    }

    .page-wrapper {
      min-height: 100vh;
    }

    /* Admin-specific badge */
    .admin-badge {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #fff;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      margin-left: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Review Notes Textarea */
    .review-notes {
      width: 100%;
      min-height: 80px;
      padding: 12px 16px;
      font-size: 14px;
      border: 2px solid rgba(47, 160, 111, 0.3);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      resize: vertical;
      margin-top: 15px;
    }

    .review-notes:focus {
      outline: none;
      border-color: var(--pkl-primary);
    }

    .review-notes::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    /* Quick Stats Row */
    .quick-actions {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
    }

    .quick-action-btn {
      flex: 1;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(47, 160, 111, 0.3);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .quick-action-btn:hover {
      border-color: var(--pkl-accent);
      transform: translateY(-3px);
    }

    .quick-action-btn i {
      font-size: 24px;
      color: var(--pkl-primary);
    }

    .quick-action-btn .text {
      text-align: left;
    }

    .quick-action-btn .text h4 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .quick-action-btn .text p {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      margin: 0;
    }

    /* Access Denied Screen */
    .access-denied {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      text-align: center;
      padding: 40px;
    }

    .access-denied i {
      font-size: 80px;
      color: var(--pkl-danger);
      margin-bottom: 20px;
    }

    .access-denied h2 {
      color: #fff;
      font-size: 32px;
      margin-bottom: 15px;
    }

    .access-denied p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 16px;
      max-width: 400px;
      margin-bottom: 30px;
    }

    .access-denied .btn-home {
      padding: 14px 30px;
      background: linear-gradient(135deg,
          var(--pkl-primary) 0%,
          var(--pkl-accent) 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }

    /* Dashboard Tabs */
    .dashboard-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid rgba(47, 160, 111, 0.2);
      padding-bottom: 15px;
    }

    .dashboard-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dashboard-tab:hover {
      color: #fff;
      background: rgba(47, 160, 111, 0.1);
    }

    .dashboard-tab.active {
      color: #fff;
      background: var(--pkl-primary);
    }

    .dashboard-tab i {
      font-size: 16px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Admin Table Styles */
    .super-admin-badge {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 8px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .admin-user-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div id="pkl-header"></div>

    <!-- Main Content -->
    <main class="dashboard-main" id="main-content">
      <div class="container">
        <!-- Access Check Overlay -->
        <div id="access-check" style="display: none">
          <div class="access-denied">
            <i class="fas fa-shield-alt"></i>
            <h2>Verifying Access...</h2>
            <p>Please wait while we verify your admin credentials.</p>
          </div>
        </div>

        <!-- Dashboard Content (hidden until verified) -->
        <div id="dashboard-content" style="display: none">
          <h1 class="dashboard-title">
            Admin Dashboard
            <span class="admin-badge">Admin</span>
          </h1>
          <p class="dashboard-subtitle">
            Manage event applications, users, and platform settings
          </p>

          <!-- Quick Links -->
          <div style="margin-bottom: 20px;">
            <a href="/api-docs" target="_blank"
              style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; background: rgba(47, 160, 111, 0.15); border: 1px solid rgba(47, 160, 111, 0.3); border-radius: 8px; color: #7ed957; font-size: 13px; font-weight: 500; text-decoration: none; transition: all 0.3s ease;"
              onmouseover="this.style.background='rgba(47, 160, 111, 0.25)';this.style.borderColor='#2fa06f';"
              onmouseout="this.style.background='rgba(47, 160, 111, 0.15)';this.style.borderColor='rgba(47, 160, 111, 0.3)';">
              <i class="fas fa-book"></i> API Docs
            </a>
          </div>

          <!-- Dashboard Tabs -->
          <div class="dashboard-tabs">
            <button class="dashboard-tab active" data-tab="events">
              <i class="fas fa-calendar-alt"></i> Events
            </button>
            <button class="dashboard-tab" data-tab="admins">
              <i class="fas fa-user-shield"></i> Admin Users
            </button>
            <button class="dashboard-tab" data-tab="users">
              <i class="fas fa-users"></i> User Passes
            </button>
          </div>

          <!-- Events Tab Content -->
          <div class="tab-content active" id="tab-events">
            <!-- Stats Grid -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-icon pending">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="stat-pending">0</div>
                <div class="stat-label">Pending Review</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon approved">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-value" id="stat-approved">0</div>
                <div class="stat-label">Approved Events</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon completed">
                  <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-value" id="stat-completed">0</div>
                <div class="stat-label">Completed Events</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon rejected">
                  <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-value" id="stat-rejected">0</div>
                <div class="stat-label">Rejected</div>
              </div>
            </div>

            <!-- Actions Bar -->
            <div class="actions-bar">
              <div class="filter-tabs">
                <button class="filter-tab active" data-filter="pending">
                  Pending Review
                </button>
                <button class="filter-tab" data-filter="approved">
                  Approved
                </button>
                <button class="filter-tab" data-filter="completed">
                  Completed
                </button>
                <button class="filter-tab" data-filter="rejected">
                  Rejected
                </button>
                <button class="filter-tab" data-filter="all">
                  All Events
                </button>
              </div>
              <button class="btn-create-event" onclick="openCreateEventModal()">
                <i class="fas fa-plus"></i> Create Event
              </button>
            </div>

            <!-- Events Table -->
            <div class="events-table-card">
              <table class="events-table">
                <thead>
                  <tr>
                    <th>Event Name</th>
                    <th>Operator</th>
                    <th>Location</th>
                    <th>Dates</th>
                    <th>Status</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="events-table-body">
                  <tr>
                    <td colspan="7">
                      <div class="no-events">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h4>Loading events...</h4>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Admin Users Tab Content -->
          <div class="tab-content" id="tab-admins">
            <!-- Admin Stats -->
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr)">
              <div class="stat-card">
                <div class="stat-icon" style="background: rgba(99, 102, 241, 0.2); color: #6366f1">
                  <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-value" id="stat-total-admins">0</div>
                <div class="stat-label">Total Admins</div>
              </div>
              <div class="stat-card">
                <div class="stat-icon approved">
                  <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-value" id="stat-active-admins">0</div>
                <div class="stat-label">Active Admins</div>
              </div>
            </div>

            <!-- Admin Actions Bar -->
            <div class="actions-bar">
              <h3 style="color: #fff; font-size: 18px">
                Manage Admin Accounts
              </h3>
              <button class="btn-create-event" onclick="openCreateAdminModal()">
                <i class="fas fa-user-plus"></i> Create Admin
              </button>
            </div>

            <!-- Admins Table -->
            <div class="events-table-card">
              <table class="events-table">
                <thead>
                  <tr>
                    <th>Admin</th>
                    <th>Email</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="admins-table-body">
                  <tr>
                    <td colspan="5">
                      <div class="no-events">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h4>Loading admins...</h4>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- User Passes Tab Content -->
          <div class="tab-content" id="tab-users">
            <div class="info-box" style="margin-bottom: 25px;">
              <i class="fas fa-info-circle"></i>
              <h4>Grant Fee Passes</h4>
              <p>Search for players or operators by name, username or email. Grant passes to bypass membership or event
                registration fees. Use <strong>-1</strong> for unlimited passes.</p>
            </div>

            <!-- User Search -->
            <div class="actions-bar" style="flex-wrap: wrap; gap: 12px;">
              <div style="flex: 1; min-width: 260px; position: relative;">
                <input type="text" class="form-control" id="user-search-input"
                  placeholder="Search by username, email, or name (min 2 chars)..."
                  style="width: 100%; padding-right: 40px;" />
                <i class="fas fa-search"
                  style="position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.4);"></i>
              </div>
              <button class="btn-create-event" onclick="searchUsers()" id="btn-search-users">
                <i class="fas fa-search"></i> Search
              </button>
            </div>

            <!-- User Results Table -->
            <div class="events-table-card">
              <table class="events-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Type</th>
                    <th>Membership Passes</th>
                    <th>Event Fee Passes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <tr>
                    <td colspan="6">
                      <div class="no-events">
                        <i class="fas fa-search"></i>
                        <h4>Search for Users</h4>
                        <p>Use the search bar above to find players and operators</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Event Details Modal -->
    <div class="modal-overlay" id="details-modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h3 id="details-modal-title">Event Details</h3>
          <button class="modal-close" onclick="closeModal('details-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="event-details-grid" id="event-details-content">
            <!-- Populated by JavaScript -->
          </div>

          <div id="review-actions" style="margin-top: 30px; display: none">
            <h4 style="color: #fff; margin-bottom: 15px">Review Decision</h4>
            <textarea class="review-notes" id="review-notes" placeholder="Add review notes (optional)..."></textarea>
          </div>
        </div>
        <div class="modal-footer" id="details-modal-footer">
          <button class="btn-cancel" onclick="closeModal('details-modal')">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm Reject Modal -->
    <div class="modal-overlay" id="reject-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Reject Event Application</h3>
          <button class="modal-close" onclick="closeModal('reject-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>Are you sure?</h4>
            <p>
              This will reject the event application. The operator will be
              notified of this decision.
            </p>
          </div>
          <input type="hidden" id="reject-event-id" />
          <div class="form-group">
            <label>Rejection Reason <span class="required">*</span></label>
            <textarea class="form-control" id="reject-reason" placeholder="Provide a reason for rejection..."
              required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeModal('reject-modal')">
            Cancel
          </button>
          <button class="btn-submit danger" onclick="confirmReject()">
            Reject Application
          </button>
        </div>
      </div>
    </div>

    <!-- Create Event Modal -->
    <div class="modal-overlay" id="create-event-modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h3>Create New Event</h3>
          <button class="modal-close" onclick="closeModal('create-event-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <h4>Admin-Created Event</h4>
            <p>
              Events created by admins are automatically approved and will
              appear in the Pathway Series immediately.
            </p>
          </div>

          <form id="create-event-form">
            <div class="form-group">
              <label>Event Name <span class="required">*</span></label>
              <input type="text" class="form-control" id="event-name" placeholder="e.g., Miami Open 2026" required />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Country <span class="required">*</span></label>
                <input type="text" class="form-control" id="event-country" placeholder="e.g., United States" required />
              </div>
              <div class="form-group">
                <label>State <span class="required">*</span></label>
                <input type="text" class="form-control" id="event-state" placeholder="e.g., Florida" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" class="form-control" id="event-city" placeholder="e.g., Miami" />
              </div>
              <div class="form-group">
                <label>Court Name <span class="required">*</span></label>
                <input type="text" class="form-control" id="event-court" placeholder="e.g., Crandon Park Tennis Center"
                  required />
              </div>
            </div>

            <div class="form-group">
              <label>Address</label>
              <input type="text" class="form-control" id="event-address" placeholder="Full address" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Start Date <span class="required">*</span></label>
                <input type="date" class="form-control" id="event-start-date" required />
              </div>
              <div class="form-group">
                <label>End Date <span class="required">*</span></label>
                <input type="date" class="form-control" id="event-end-date" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Max Participants</label>
                <input type="number" class="form-control" id="event-max-participants" placeholder="50" />
              </div>
              <div class="form-group">
                <label>Entry Fee ($)</label>
                <input type="number" class="form-control" id="event-entry-fee" placeholder="25.00" step="0.01" />
              </div>
            </div>

            <div class="form-group">
              <label>Tournament Website</label>
              <input type="url" class="form-control" id="event-website" placeholder="https://example.com/tournament" />
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea class="form-control" id="event-description" placeholder="Describe the event..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeModal('create-event-modal')">
            Cancel
          </button>
          <button class="btn-submit" onclick="submitEvent()">
            Create Event
          </button>
        </div>
      </div>
    </div>

    <!-- Create Admin Modal -->
    <div class="modal-overlay" id="create-admin-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Admin</h3>
          <button class="modal-close" onclick="closeModal('create-admin-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="create-admin-form">
            <div class="form-group">
              <label>Username <span class="required">*</span></label>
              <input type="text" class="form-control" id="admin-username" placeholder="admin_username" required />
            </div>

            <div class="form-group">
              <label>Email <span class="required">*</span></label>
              <input type="email" class="form-control" id="admin-email" placeholder="admin@pkl.club" required />
            </div>

            <div class="form-group">
              <label>First Name</label>
              <input type="text" class="form-control" id="admin-firstname" placeholder="John" />
            </div>

            <div class="form-group">
              <label>Last Name</label>
              <input type="text" class="form-control" id="admin-lastname" placeholder="Doe" />
            </div>

            <div class="form-group">
              <label>Password <span class="required">*</span></label>
              <input type="password" class="form-control" id="admin-password" placeholder="Strong password" required />
            </div>

            <div class="form-group">
              <label>Confirm Password <span class="required">*</span></label>
              <input type="password" class="form-control" id="admin-password-confirm" placeholder="Confirm password"
                required />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeModal('create-admin-modal')">
            Cancel
          </button>
          <button class="btn-submit" onclick="submitCreateAdmin()">
            Create Admin
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Admin Modal -->
    <div class="modal-overlay" id="edit-admin-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Admin</h3>
          <button class="modal-close" onclick="closeModal('edit-admin-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-admin-id" />
          <form id="edit-admin-form">
            <div class="form-group">
              <label>Username <span class="required">*</span></label>
              <input type="text" class="form-control" id="edit-admin-username" required />
            </div>

            <div class="form-group">
              <label>Email <span class="required">*</span></label>
              <input type="email" class="form-control" id="edit-admin-email" required />
            </div>

            <div class="form-group">
              <label>First Name</label>
              <input type="text" class="form-control" id="edit-admin-firstname" />
            </div>

            <div class="form-group">
              <label>Last Name</label>
              <input type="text" class="form-control" id="edit-admin-lastname" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeModal('edit-admin-modal')">
            Cancel
          </button>
          <button class="btn-submit" onclick="submitEditAdmin()">
            Save Changes
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Admin Confirm Modal -->
    <div class="modal-overlay" id="delete-admin-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Delete Admin Account</h3>
          <button class="modal-close" onclick="closeModal('delete-admin-modal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="warning-box">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>This action cannot be undone!</h4>
            <p>
              Are you sure you want to delete the admin account "<span id="delete-admin-name"></span>"? This will
              permanently remove their access to the admin
              dashboard.
            </p>
          </div>
          <input type="hidden" id="delete-admin-id" />
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeModal('delete-admin-modal')">
            Cancel
          </button>
          <button class="btn-submit danger" onclick="confirmDeleteAdmin()">
            Delete Admin
          </button>
        </div>
      </div>
    </div>
    <!-- Grant Pass Modal -->
    <div class="modal-overlay" id="grant-pass-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Grant Fee Passes</h3>
          <button class="modal-close" onclick="closeModal('grant-pass-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="info-box" style="margin-bottom: 20px;">
            <i class="fas fa-ticket-alt"></i>
            <h4 id="grant-pass-user-label">User</h4>
            <p>Set the number of passes. Use <strong>-1</strong> for infinite (unlimited). Use <strong>0</strong> to
              remove all passes.</p>
          </div>
          <input type="hidden" id="grant-pass-user-id" />

          <div class="form-group">
            <label>Membership Passes</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="number" class="form-control" id="grant-membership-passes" min="-1" value="0"
                style="flex: 1;" />
              <button class="btn-action approve" style="padding: 10px 16px; white-space: nowrap;"
                onclick="document.getElementById('grant-membership-passes').value = -1">
                <i class="fas fa-infinity"></i> Infinite
              </button>
            </div>
            <small style="color: rgba(255,255,255,0.5); margin-top: 4px; display: block;">
              Allows bypassing the membership requirement for event registration
            </small>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label>Event Fee Passes</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="number" class="form-control" id="grant-event-passes" min="-1" value="0" style="flex: 1;" />
              <button class="btn-action approve" style="padding: 10px 16px; white-space: nowrap;"
                onclick="document.getElementById('grant-event-passes').value = -1">
                <i class="fas fa-infinity"></i> Infinite
              </button>
            </div>
            <small style="color: rgba(255,255,255,0.5); margin-top: 4px; display: block;">
              Allows skipping Stripe payment when registering for events (each registration consumes 1 pass)
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" onclick="closeModal('grant-pass-modal')">Cancel</button>
          <button class="btn-submit" onclick="submitGrantPasses()">
            <i class="fas fa-save"></i> Save Passes
          </button>
        </div>
      </div>
    </div>

  </div>
  <!-- End page-wrapper -->

  <!-- Scripts -->
  <script src="js/jquery.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/script.js"></script>
  <script src="js/pkl-header-component.js"></script>
  <script src="js/dashboard-utils.js"></script>

  <script>
    let currentUser = null;
    let allEvents = [];
    let allAdmins = [];
    let searchedUsers = [];
    let currentFilter = "pending";
    let currentEventId = null;
    const SUPER_ADMIN_USERNAME = "eman";

    /**
     * Initialize Dashboard - Secure Admin Verification
     */
    async function initDashboard() {
      document.getElementById("access-check").style.display = "block";
      document.getElementById("dashboard-content").style.display = "none";

      const authResult = await verifyAdminAccess();

      if (!authResult.authorized) {
        showAccessDenied(authResult.reason);
        return;
      }

      currentUser = authResult.user;
      document.getElementById("access-check").style.display = "none";
      document.getElementById("dashboard-content").style.display = "block";

      // Setup tab switching
      setupTabs();

      await loadEvents();
    }

    /**
     * Setup Dashboard Tabs
     */
    function setupTabs() {
      document.querySelectorAll(".dashboard-tab").forEach((tab) => {
        tab.addEventListener("click", function () {
          document
            .querySelectorAll(".dashboard-tab")
            .forEach((t) => t.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));

          this.classList.add("active");
          const tabId = this.dataset.tab;
          document.getElementById(`tab-${tabId}`).classList.add("active");

          // Load data for the tab
          if (tabId === "admins") {
            loadAdmins();
          } else if (tabId === "users") {
            // Focus search input when switching to users tab
            setTimeout(() => document.getElementById("user-search-input")?.focus(), 100);
          }
        });
      });
    }

    /**
     * Show Access Denied Screen
     */
    function showAccessDenied(reason) {
      document.getElementById("access-check").innerHTML = `
          <div class="access-denied">
            <i class="fas fa-shield-alt"></i>
            <h2>Access Denied</h2>
            <p>You don't have permission to access the admin dashboard. ${reason ? `(${reason})` : ""}</p>
            <a href="index.html" class="btn-home">Return to Home</a>
          </div>
        `;
    }

    /**
     * Load All Events
     */
    async function loadEvents() {
      showLoadingState("events-table-body");

      try {
        const events = await apiRequest("/events");
        allEvents = events;
        updateStats();
        renderEvents();
      } catch (error) {
        console.error("Error loading events:", error);
        showToast("Failed to load events: " + error.message, "error");
      }
    }

    /**
     * Load All Admins
     */
    async function loadAdmins() {
      document.getElementById("admins-table-body").innerHTML = `
          <tr><td colspan="5"><div class="no-events"><i class="fas fa-spinner fa-spin"></i><h4>Loading admins...</h4></div></td></tr>
        `;

      try {
        const admins = await apiRequest("/users/admins");
        allAdmins = admins;
        updateAdminStats();
        renderAdmins();
      } catch (error) {
        console.error("Error loading admins:", error);
        showToast("Failed to load admins: " + error.message, "error");
      }
    }

    /**
     * Update Dashboard Stats
     */
    function updateStats() {
      const stats = {
        pending: allEvents.filter((e) => e.status === "pending").length,
        approved: allEvents.filter((e) => e.status === "approved").length,
        completed: allEvents.filter((e) => e.status === "completed").length,
        rejected: allEvents.filter((e) => e.status === "rejected").length,
      };

      document.getElementById("stat-pending").textContent = stats.pending;
      document.getElementById("stat-approved").textContent = stats.approved;
      document.getElementById("stat-completed").textContent = stats.completed;
      document.getElementById("stat-rejected").textContent = stats.rejected;
    }

    /**
     * Update Admin Stats
     */
    function updateAdminStats() {
      document.getElementById("stat-total-admins").textContent =
        allAdmins.length;
      document.getElementById("stat-active-admins").textContent =
        allAdmins.filter((a) => a.isActive !== false).length;
    }

    /**
     * Render Events Table
     */
    function renderEvents() {
      const filtered =
        currentFilter === "all"
          ? allEvents
          : allEvents.filter((e) => e.status === currentFilter);

      if (filtered.length === 0) {
        showEmptyState(
          "events-table-body",
          "fa-calendar-alt",
          currentFilter === "pending"
            ? "No Pending Applications"
            : "No Events Found",
          currentFilter === "pending"
            ? "All caught up! No event applications awaiting review."
            : "No events match the selected filter.",
        );
        return;
      }

      document.getElementById("events-table-body").innerHTML = filtered
        .map(
          (event) => `
              <tr>
                <td data-label="Event Name"><div class="event-name">${event.name}</div></td>
                <td data-label="Operator"><span class="operator-name">${event.operator?.username || event.operator?.email || "Admin"}</span></td>
                <td data-label="Location"><div class="event-location">${formatLocation(event.location)}</div></td>
                <td data-label="Dates">${formatDate(event.startDate)} - ${formatDate(event.endDate)}</td>
                <td data-label="Status">${getStatusBadge(event.status)}</td>
                <td data-label="Submitted">${formatDate(event.createdAt)}</td>
                <td data-label="Actions">
                  <div class="action-buttons">
                    <button class="btn-action view" onclick="viewEvent('${event._id}')">
                      <i class="fas fa-eye"></i> View
                    </button>
                    ${event.status === "pending"
              ? `
                      <button class="btn-action approve" onclick="approveEvent('${event._id}')">
                        <i class="fas fa-check"></i> Approve
                      </button>
                      <button class="btn-action reject" onclick="openRejectModal('${event._id}')">
                        <i class="fas fa-times"></i> Reject
                      </button>
                    `
              : ""
            }
                  </div>
                </td>
              </tr>
            `,
        )
        .join("");
    }

    /**
     * Render Admins Table
     */
    function renderAdmins() {
      if (allAdmins.length === 0) {
        showEmptyState(
          "admins-table-body",
          "fa-user-shield",
          "No Admin Users",
          "Create an admin account to get started.",
        );
        return;
      }

      document.getElementById("admins-table-body").innerHTML = allAdmins
        .map((admin) => {
          const isSuperAdmin = admin.username === SUPER_ADMIN_USERNAME;
          const initial = (admin.firstName || admin.username || "A")
            .charAt(0)
            .toUpperCase();

          return `
              <tr>
                <td data-label="Admin">
                  <div class="admin-user-row">
                    <div class="admin-avatar">${initial}</div>
                    <div>
                      <div class="event-name">
                        ${admin.firstName ? `${admin.firstName} ${admin.lastName || ""}` : admin.username}
                        ${isSuperAdmin ? '<span class="super-admin-badge">Super Admin</span>' : ""}
                      </div>
                      <div class="event-location">@${admin.username}</div>
                    </div>
                  </div>
                </td>
                <td data-label="Email">${admin.email}</td>
                <td data-label="Created">${formatDate(admin.createdAt)}</td>
                <td data-label="Status">${admin.isActive !== false ? '<span class="status-badge approved">Active</span>' : '<span class="status-badge rejected">Inactive</span>'}</td>
                <td data-label="Actions">
                  <div class="action-buttons">
                    ${isSuperAdmin
              ? `
                      <button class="btn-action view" disabled title="Super admin cannot be modified">
                        <i class="fas fa-lock"></i> Protected
                      </button>
                    `
              : `
                      <button class="btn-action view" onclick="openEditAdminModal('${admin._id}')">
                        <i class="fas fa-edit"></i> Edit
                      </button>
                      <button class="btn-action reject" onclick="openDeleteAdminModal('${admin._id}', '${admin.username}')">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    `
            }
                  </div>
                </td>
              </tr>
            `;
        })
        .join("");
    }

    /**
     * View Event Details
     */
    function viewEvent(eventId) {
      const event = allEvents.find((e) => e._id === eventId);
      if (!event) return;

      currentEventId = eventId;
      document.getElementById("details-modal-title").textContent = event.name;

      const details = `
          <div class="event-detail-item"><label>Operator</label><span>${event.operator?.username || event.operator?.email || "Admin"}</span></div>
          <div class="event-detail-item"><label>Status</label><span>${getStatusBadge(event.status)}</span></div>
          <div class="event-detail-item"><label>Country</label><span>${event.location?.country || "N/A"}</span></div>
          <div class="event-detail-item"><label>State</label><span>${event.location?.state || "N/A"}</span></div>
          <div class="event-detail-item"><label>City</label><span>${event.location?.city || "N/A"}</span></div>
          <div class="event-detail-item"><label>Court Name</label><span>${event.location?.courtName || "N/A"}</span></div>
          <div class="event-detail-item"><label>Start Date</label><span>${formatDate(event.startDate)}</span></div>
          <div class="event-detail-item"><label>End Date</label><span>${formatDate(event.endDate)}</span></div>
          <div class="event-detail-item"><label>Tournament Site</label><span>${event.tournamentSite ? `<a href="${event.tournamentSite}" target="_blank" style="color: var(--pkl-accent);">${event.tournamentSite}</a>` : "N/A"}</span></div>
          <div class="event-detail-item"><label>Registered Players</label><span>${event.registeredPlayers?.length || 0}</span></div>
          ${event.winner ? `<div class="event-detail-item full-width"><label>Winner</label><span><i class="fas fa-trophy" style="color: gold; margin-right: 8px;"></i>${event.winner.playerName}</span></div>` : ""}
          ${event.description ? `<div class="event-detail-item full-width"><label>Description</label><span>${event.description}</span></div>` : ""}
          <div class="event-detail-item"><label>Submitted</label><span>${formatDateTime(event.createdAt)}</span></div>
          <div class="event-detail-item"><label>Last Updated</label><span>${formatDateTime(event.updatedAt)}</span></div>
        `;

      document.getElementById("event-details-content").innerHTML = details;

      const reviewActions = document.getElementById("review-actions");
      const footer = document.getElementById("details-modal-footer");

      if (event.status === "pending") {
        reviewActions.style.display = "block";
        footer.innerHTML = `
            <button class="btn-cancel" onclick="closeModal('details-modal')">Close</button>
            <button class="btn-action reject" style="padding: 12px 24px;" onclick="openRejectModal('${event._id}'); closeModal('details-modal');">
              <i class="fas fa-times"></i> Reject
            </button>
            <button class="btn-action approve" style="padding: 12px 24px;" onclick="approveEventFromModal()">
              <i class="fas fa-check"></i> Approve
            </button>
          `;
      } else {
        reviewActions.style.display = "none";
        footer.innerHTML = `<button class="btn-cancel" onclick="closeModal('details-modal')">Close</button>`;
      }

      openModal("details-modal");
    }

    /**
     * Approve Event
     */
    async function approveEvent(eventId) {
      if (!confirm("Are you sure you want to approve this event?")) return;

      try {
        await apiRequest(`/events/${eventId}/review`, {
          method: "PATCH",
          body: JSON.stringify({ status: "approved", reviewNotes: "" }),
        });

        showToast("Event approved successfully! ✅", "success");
        await loadEvents();
      } catch (error) {
        console.error("Error approving event:", error);
        showToast("Failed to approve event: " + error.message, "error");
      }
    }

    /**
     * Approve from Modal (with notes)
     */
    async function approveEventFromModal() {
      const notes = document.getElementById("review-notes").value;

      try {
        await apiRequest(`/events/${currentEventId}/review`, {
          method: "PATCH",
          body: JSON.stringify({ status: "approved", reviewNotes: notes }),
        });

        showToast("Event approved successfully! ✅", "success");
        closeModal("details-modal");
        await loadEvents();
      } catch (error) {
        console.error("Error approving event:", error);
        showToast("Failed to approve event: " + error.message, "error");
      }
    }

    /**
     * Open Reject Modal
     */
    function openRejectModal(eventId) {
      document.getElementById("reject-event-id").value = eventId;
      document.getElementById("reject-reason").value = "";
      openModal("reject-modal");
    }

    /**
     * Confirm Rejection
     */
    async function confirmReject() {
      const eventId = document.getElementById("reject-event-id").value;
      const reason = document.getElementById("reject-reason").value.trim();

      if (!reason) {
        showToast("Please provide a reason for rejection", "warning");
        return;
      }

      try {
        await apiRequest(`/events/${eventId}/review`, {
          method: "PATCH",
          body: JSON.stringify({ status: "rejected", reviewNotes: reason }),
        });

        showToast("Event application rejected", "info");
        closeModal("reject-modal");
        await loadEvents();
      } catch (error) {
        console.error("Error rejecting event:", error);
        showToast("Failed to reject event: " + error.message, "error");
      }
    }

    /* ===== CREATE EVENT ===== */

    function openCreateEventModal() {
      document.getElementById("create-event-form").reset();
      openModal("create-event-modal");
    }

    async function submitEvent() {
      const eventData = {
        name: document.getElementById("event-name").value,
        location: {
          country: document.getElementById("event-country").value,
          state: document.getElementById("event-state").value,
          city: document.getElementById("event-city").value,
          courtName: document.getElementById("event-court").value,
          address: document.getElementById("event-address").value,
        },
        startDate: document.getElementById("event-start-date").value,
        endDate: document.getElementById("event-end-date").value,
        maxParticipants:
          parseInt(document.getElementById("event-max-participants").value) ||
          undefined,
        entryFee:
          parseFloat(document.getElementById("event-entry-fee").value) ||
          undefined,
        tournamentSite:
          document.getElementById("event-website").value || undefined,
        description:
          document.getElementById("event-description").value || undefined,
      };

      if (
        !eventData.name ||
        !eventData.location.country ||
        !eventData.location.state ||
        !eventData.location.courtName ||
        !eventData.startDate ||
        !eventData.endDate
      ) {
        showToast("Please fill in all required fields", "warning");
        return;
      }

      try {
        await apiRequest("/events", {
          method: "POST",
          body: JSON.stringify(eventData),
        });

        showToast("Event created and approved! ✅", "success");
        closeModal("create-event-modal");
        await loadEvents();
      } catch (error) {
        console.error("Error creating event:", error);
        showToast("Error: " + error.message, "error");
      }
    }

    /* ===== ADMIN CRUD ===== */

    function openCreateAdminModal() {
      document.getElementById("create-admin-form").reset();
      openModal("create-admin-modal");
    }

    async function submitCreateAdmin() {
      const username = document.getElementById("admin-username").value.trim();
      const email = document.getElementById("admin-email").value.trim();
      const firstName = document
        .getElementById("admin-firstname")
        .value.trim();
      const lastName = document.getElementById("admin-lastname").value.trim();
      const password = document.getElementById("admin-password").value;
      const passwordConfirm = document.getElementById(
        "admin-password-confirm",
      ).value;

      if (!username || !email || !password) {
        showToast("Please fill in all required fields", "warning");
        return;
      }

      if (password !== passwordConfirm) {
        showToast("Passwords do not match", "error");
        return;
      }

      if (password.length < 6) {
        showToast("Password must be at least 6 characters", "warning");
        return;
      }

      try {
        await apiRequest("/users/admins", {
          method: "POST",
          body: JSON.stringify({
            username,
            email,
            password,
            firstName,
            lastName,
            userType: "admin",
          }),
        });

        showToast("Admin account created successfully! ✅", "success");
        closeModal("create-admin-modal");
        await loadAdmins();
      } catch (error) {
        console.error("Error creating admin:", error);
        showToast("Error: " + error.message, "error");
      }
    }

    function openEditAdminModal(adminId) {
      const admin = allAdmins.find((a) => a._id === adminId);
      if (!admin) return;

      document.getElementById("edit-admin-id").value = admin._id;
      document.getElementById("edit-admin-username").value = admin.username;
      document.getElementById("edit-admin-email").value = admin.email;
      document.getElementById("edit-admin-firstname").value =
        admin.firstName || "";
      document.getElementById("edit-admin-lastname").value =
        admin.lastName || "";

      openModal("edit-admin-modal");
    }

    async function submitEditAdmin() {
      const adminId = document.getElementById("edit-admin-id").value;
      const username = document
        .getElementById("edit-admin-username")
        .value.trim();
      const email = document.getElementById("edit-admin-email").value.trim();
      const firstName = document
        .getElementById("edit-admin-firstname")
        .value.trim();
      const lastName = document
        .getElementById("edit-admin-lastname")
        .value.trim();

      if (!username || !email) {
        showToast("Username and email are required", "warning");
        return;
      }

      try {
        await apiRequest(`/users/admins/${adminId}`, {
          method: "PATCH",
          body: JSON.stringify({ username, email, firstName, lastName }),
        });

        showToast("Admin updated successfully! ✅", "success");
        closeModal("edit-admin-modal");
        await loadAdmins();
      } catch (error) {
        console.error("Error updating admin:", error);
        showToast("Error: " + error.message, "error");
      }
    }

    function openDeleteAdminModal(adminId, adminUsername) {
      document.getElementById("delete-admin-id").value = adminId;
      document.getElementById("delete-admin-name").textContent =
        adminUsername;
      openModal("delete-admin-modal");
    }

    async function confirmDeleteAdmin() {
      const adminId = document.getElementById("delete-admin-id").value;

      try {
        await apiRequest(`/users/admins/${adminId}`, { method: "DELETE" });

        showToast("Admin account deleted", "info");
        closeModal("delete-admin-modal");
        await loadAdmins();
      } catch (error) {
        console.error("Error deleting admin:", error);
        showToast("Error: " + error.message, "error");
      }
    }

    /* ===== USER PASSES ===== */

    async function searchUsers() {
      const query = document.getElementById("user-search-input").value.trim();
      if (query.length < 2) {
        showToast("Please enter at least 2 characters to search", "warning");
        return;
      }

      document.getElementById("users-table-body").innerHTML = `
        <tr><td colspan="6"><div class="no-events"><i class="fas fa-spinner fa-spin"></i><h4>Searching...</h4></div></td></tr>
      `;

      try {
        const users = await apiRequest(`/users/search?q=${encodeURIComponent(query)}`);
        searchedUsers = users;
        renderSearchedUsers();
      } catch (error) {
        console.error("Error searching users:", error);
        showToast("Search failed: " + error.message, "error");
      }
    }

    function renderSearchedUsers() {
      if (searchedUsers.length === 0) {
        document.getElementById("users-table-body").innerHTML = `
          <tr><td colspan="6"><div class="no-events">
            <i class="fas fa-user-slash"></i>
            <h4>No Users Found</h4>
            <p>Try a different search term</p>
          </div></td></tr>
        `;
        return;
      }

      document.getElementById("users-table-body").innerHTML = searchedUsers.map(user => {
        const name = user.firstName ? `${user.firstName} ${user.lastName || ""}` : user.username;
        const initial = (user.firstName || user.username || "U").charAt(0).toUpperCase();
        const typeColor = user.userType === "player" ? "#2fa06f" : user.userType === "operator" ? "#6366f1" : "#f59e0b";
        const memberPasses = user.membershipPasses ?? 0;
        const eventPasses = user.eventFeePasses ?? 0;

        function passDisplay(val) {
          if (val === -1) return '<span class="status-badge approved" style="font-size: 12px;"><i class="fas fa-infinity"></i> Infinite</span>';
          if (val > 0) return `<span class="status-badge approved" style="font-size: 12px;">${val} remaining</span>`;
          return '<span class="status-badge rejected" style="font-size: 12px;">None</span>';
        }

        return `
          <tr>
            <td data-label="User">
              <div class="admin-user-row">
                <div class="admin-avatar" style="background: ${typeColor}22; color: ${typeColor};">${initial}</div>
                <div>
                  <div class="event-name">${name}</div>
                  <div class="event-location">@${user.username}</div>
                </div>
              </div>
            </td>
            <td data-label="Email">${user.email || "—"}</td>
            <td data-label="Type"><span class="status-badge" style="background: ${typeColor}22; color: ${typeColor}; text-transform: capitalize;">${user.userType}</span></td>
            <td data-label="Membership Passes">${passDisplay(memberPasses)}</td>
            <td data-label="Event Fee Passes">${passDisplay(eventPasses)}</td>
            <td data-label="Actions">
              <div class="action-buttons">
                <button class="btn-action approve" onclick="openGrantPassModal('${user._id}')">
                  <i class="fas fa-ticket-alt"></i> Passes
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function openGrantPassModal(userId) {
      const user = searchedUsers.find(u => u._id === userId);
      if (!user) return;

      const name = user.firstName ? `${user.firstName} ${user.lastName || ""}` : user.username;
      document.getElementById("grant-pass-user-label").textContent = `${name} (@${user.username}) — ${user.userType}`;
      document.getElementById("grant-pass-user-id").value = userId;
      document.getElementById("grant-membership-passes").value = user.membershipPasses ?? 0;
      document.getElementById("grant-event-passes").value = user.eventFeePasses ?? 0;

      openModal("grant-pass-modal");
    }

    async function submitGrantPasses() {
      const userId = document.getElementById("grant-pass-user-id").value;
      const membershipPasses = parseInt(document.getElementById("grant-membership-passes").value);
      const eventFeePasses = parseInt(document.getElementById("grant-event-passes").value);

      if (isNaN(membershipPasses) || isNaN(eventFeePasses)) {
        showToast("Please enter valid numbers", "warning");
        return;
      }

      if (membershipPasses < -1 || eventFeePasses < -1) {
        showToast("Minimum value is -1 (infinite)", "warning");
        return;
      }

      try {
        await apiRequest(`/users/${userId}/passes`, {
          method: "PATCH",
          body: JSON.stringify({ membershipPasses, eventFeePasses }),
        });

        showToast("Passes updated successfully! ✅", "success");
        closeModal("grant-pass-modal");

        // Refresh the search results
        const user = searchedUsers.find(u => u._id === userId);
        if (user) {
          user.membershipPasses = membershipPasses;
          user.eventFeePasses = eventFeePasses;
          renderSearchedUsers();
        }
      } catch (error) {
        console.error("Error granting passes:", error);
        showToast("Error: " + error.message, "error");
      }
    }

    // Search on Enter key
    document.addEventListener("DOMContentLoaded", function () {
      const searchInput = document.getElementById("user-search-input");
      if (searchInput) {
        searchInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            searchUsers();
          }
        });
      }
    });

    /**
     * Filter Tab Click Handlers
     */
    document.querySelectorAll(".filter-tab").forEach((tab) => {
      tab.addEventListener("click", function () {
        document
          .querySelectorAll(".filter-tab")
          .forEach((t) => t.classList.remove("active"));
        this.classList.add("active");
        currentFilter = this.dataset.filter;
        renderEvents();
      });
    });

    // Initialize on page load
    initDashboard();
  </script>
</body>

</html>